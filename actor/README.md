# Actor - 量化交易机器人系统

Actor 是一个高性能的量化交易机器人系统，支持多交易所、远程控制和自动化交易策略执行。

## 项目架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Backend Control System                            │
│                          (远程控制后台 - WebSocket)                           │
└─────────────────────────────────────┬───────────────────────────────────────┘
                                      │
                    ┌─────────────────┼─────────────────┐
                    │     WebSocket Commands            │
                    │  (register/start/stop/status)     │
                    └─────────────────┼─────────────────┘
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Actor Server                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                        cmd/server/main.go                           │    │
│  │  • 加载配置 (configs/config.yaml)                                    │    │
│  │  • 初始化日志系统                                                     │    │
│  │  • 启动各管理器                                                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                      │                                      │
│         ┌────────────────────────────┼────────────────────────────┐         │
│         │                            │                            │         │
│         ▼                            ▼                            ▼         │
│  ┌─────────────┐            ┌─────────────┐            ┌─────────────┐      │
│  │ RobotManager│            │ExchangeMgr  │            │BackendClient│      │
│  │             │            │             │            │             │      │
│  │ • 创建机器人 │            │ • 管理交易所 │            │ • 后台通信     │        │
│  │ • 启动/停止  │            │ • 连接池管理 │            │ • 心跳保活     │        │
│  │ • 状态监控   │            │ • 统一接口   │            │ • 命令处理    │       │
│  └──────┬──────┘            └──────┬──────┘            └─────────────┘      │
│         │                          │                                        │
└─────────┼──────────────────────────┼────────────────────────────────────────┘
          │                          │
          ▼                          ▼
┌─────────────────┐    ┌──────────────────────────────────────────────────────┐
│   Cat Robot     │    │                  Exchange Clients                     │
│  (量化机器人)    │    │  ┌────────────┐ ┌────────────┐ ┌────────────┐        │
│                 │    │  │  Binance   │ │    OKX     │ │   Bitget   │        │
│ ┌─────────────┐ │    │  │ ┌────────┐ │ │ ┌────────┐ │ │ ┌────────┐ │        │
│ │   Quant     │ │    │  │ │  Spot  │ │ │ │  Spot  │ │ │ │  Spot  │ │        │
│ │  量化引擎    │ │    │  │ └────────┘ │ │ └────────┘ │ │ └────────┘ │        │
│ ├─────────────┤ │    │  │ ┌────────┐ │ │ ┌────────┐ │ │ ┌────────┐ │        │
│ │   Trade     │◄├────┼──┤ │USDTSwap│ │ │ │USDTSwap│ │ │ │USDTSwap│ │        │
│ │  交易执行    │ │    │  │ └────────┘ │ │ └────────┘ │ │ └────────┘ │        │
│ ├─────────────┤ │    │  └────────────┘ └────────────┘ └────────────┘        │
│ │   Market    │ │    │                       │                               │
│ │  行情处理    │ │    │         ┌─────────────┴─────────────┐                │
│ ├─────────────┤ │    │         │                           │                │
│ │  Callback   │ │    │         ▼                           ▼                │
│ │  事件回调    │ │    │  ┌─────────────┐           ┌─────────────┐           │
│ └─────────────┘ │    │  │  REST (Rs)  │           │WebSocket(Ws)│           │
└─────────────────┘    │  │  • 下单      │           │  • 实时行情  │           │
                       │  │  • 撤单      │           │  • 账户推送  │           │
                       │  │  • 查询      │           │  • 订单推送  │           │
                       │  └──────┬──────┘           └──────┬──────┘           │
                       │         │                         │                   │
                       └─────────┼─────────────────────────┼───────────────────┘
                                 │                         │
                                 └────────────┬────────────┘
                                              ▼
                              ┌───────────────────────────────┐
                              │      Exchange APIs            │
                              │   (Binance/OKX/Bitget)        │
                              └───────────────────────────────┘
```

## 核心功能流程

### 1. 系统启动流程

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  加载配置     │────▶│  初始化日志   │────▶│ 初始化管理器  │────▶│  连接后台     │
│ config.yaml  │     │   Logger     │     │ Robot/Exch   │     │  WebSocket   │
└──────────────┘     └──────────────┘     └──────────────┘     └──────────────┘
                                                                       │
                                                                       ▼
┌──────────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  等待信号     │◀────│  启动调度器   │◀────│  注册Actor   │◀────│  发送心跳     │
│  优雅退出     │     │  Schedule    │     │  Register    │     │  Heartbeat   │
└──────────────┘     └──────────────┘     └──────────────┘     └──────────────┘
```

### 2. 机器人生命周期

```
┌─────────┐    OnCreate    ┌─────────┐    OnStart    ┌─────────┐
│  空闲   │───────────────▶│  已创建  │──────────────▶│  运行中  │
│  Idle   │                │ Created │               │ Running │
└─────────┘                └─────────┘               └────┬────┘
                                ▲                        │
                                │         OnStop         │
                                │◀───────────────────────┘
                                │
                           OnDelete
                                │
                                ▼
                          ┌─────────┐
                          │  已删除  │
                          │ Deleted │
                          └─────────┘
```

### 3. 交易执行流程

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  接收信号     │────▶│  策略计算     │────▶│  风控检查     │
│  Market Data │     │   Quant      │     │ Risk Check   │
└──────────────┘     └──────────────┘     └──────┬───────┘
                                                 │
                     ┌───────────────────────────┘
                     ▼
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  状态上报     │◀────│  订单回调     │◀────│  发送订单     │
│ Status Update│     │  Callback    │     │ Place Order  │
└──────────────┘     └──────────────┘     └──────────────┘
```

### 4. 后台通信协议

```
┌─────────────────────────────────────────────────────────────┐
│                    WebSocket Protocol                        │
├─────────────────────────────────────────────────────────────┤
│  actor.register      │  注册 Actor 到后台                    │
│  actor.heartbeat     │  心跳保活                             │
│  actor.start         │  启动机器人                           │
│  actor.stop          │  停止机器人                           │
│  actor.status        │  查询状态                             │
│  actor.status_update │  状态更新推送                         │
│  actor.config        │  配置更新                             │
└─────────────────────────────────────────────────────────────┘
```

## 目录结构

```
actor/
├── cmd/                          # 服务入口
│   └── server/                   # 主服务
│       └── main.go               # 程序入口
├── broker/                       # 交易所抽象层
│   ├── base/                     # 基础接口定义
│   │   ├── rs.go                 # REST API 接口
│   │   ├── ws.go                 # WebSocket 接口
│   │   └── pridata.go            # 私有数据接口
│   ├── binance/                  # Binance 交易所
│   │   ├── spot/                 # 现货
│   │   └── usdtswap/             # U本位合约
│   ├── okx/                      # OKX 交易所
│   │   ├── spot/                 # 现货
│   │   └── usdtswap/             # U本位合约
│   └── bitget/                   # Bitget 交易所
│       ├── spot/                 # 现货
│       └── usdtswap/             # U本位合约
├── robot/                        # 机器人实现
│   └── cat/                      # Cat 机器人
│       ├── cat.go                # 机器人主逻辑
│       └── quant/                # 量化引擎
│           ├── quant.go          # 核心逻辑
│           ├── trade.go          # 交易执行
│           ├── market.go         # 行情处理
│           ├── callback.go       # 事件回调
│           ├── run.go            # 运行循环
│           └── stop.go           # 停止逻辑
├── server/                       # 服务层
│   ├── backend/                  # 后台通信
│   │   ├── client.go             # WebSocket 客户端
│   │   ├── protocol.go           # 协议定义
│   │   ├── handler.go            # 命令处理
│   │   └── reconnect.go          # 重连逻辑
│   └── service/                  # 服务管理
│       ├── manager.go            # 交易所管理器
│       ├── robot.go              # 机器人管理器
│       ├── trading.go            # 交易服务
│       ├── account.go            # 账户服务
│       └── market.go             # 行情服务
├── helper/                       # 工具函数
│   ├── config.go                 # 配置管理
│   ├── const.go                  # 常量定义
│   ├── error.go                  # 错误处理
│   ├── alert.go                  # 告警通知
│   └── ip.go                     # IP 池管理
├── schedule/                     # 定时任务
│   └── schedule.go               # 调度器
├── third/                        # 第三方库
│   ├── log/                      # 日志库
│   ├── cmap/                     # 并发 Map
│   ├── fixed/                    # 定点数运算
│   └── gcircularqueue/           # 循环队列
├── tools/                        # 工具
│   ├── ippool/                   # IP 池生成
│   └── bench/                    # 性能测试
├── configs/                      # 配置文件
│   └── config.yaml               # 主配置
├── Dockerfile                    # Docker 构建
├── build.sh                      # 构建脚本
└── go.mod                        # Go 模块
```

## 支持的交易所

| 交易所 | 现货 (Spot) | U本位合约 (USDT Swap) |
|--------|-------------|----------------------|
| Binance | ✅ | ✅ |
| OKX | ✅ | ✅ |
| Bitget | ✅ | ✅ |

## 交易所接口功能

### REST API (Rs)

| 功能 | 说明 |
|------|------|
| `PlaceOrder` | 下单 |
| `CancelOrder` | 撤单 |
| `CancelAllOrders` | 撤销所有订单 |
| `GetOpenOrders` | 获取未成交订单 |
| `GetOrderHistory` | 获取历史订单 |
| `GetPosition` | 获取持仓 |
| `GetAccount` | 获取账户信息 |
| `GetFundingRate` | 获取资金费率 |
| `SetLeverage` | 设置杠杆 |
| `SetMarginMode` | 设置保证金模式 |

### WebSocket (Ws)

| 功能 | 说明 |
|------|------|
| `SubscribeDepth` | 订阅深度数据 |
| `SubscribeTrade` | 订阅成交数据 |
| `SubscribeOrder` | 订阅订单更新 |
| `SubscribePosition` | 订阅持仓更新 |
| `SubscribeAccount` | 订阅账户更新 |

## 快速开始

### 1. 配置

编辑 `configs/config.yaml`:

```yaml
server:
  backend_url: "ws://your-backend:8080/ws"
  actor_id: "actor-001"

exchange:
  binance:
    api_key: "your-api-key"
    secret_key: "your-secret-key"

logging:
  level: "info"
  output: "stdout"
```

### 2. 构建

```bash
# 使用构建脚本
./build.sh

# 或手动构建
go build -o actor ./cmd/server
```

### 3. 运行

```bash
./actor
```

### 4. Docker 部署

```bash
# 构建镜像
docker build -t actor:latest .

# 运行容器
docker run -d --name actor \
  -v $(pwd)/configs:/app/configs \
  actor:latest
```

## 技术栈

| 组件 | 技术 | 用途 |
|------|------|------|
| HTTP 客户端 | net/http | 交易所 REST API |
| WebSocket | gorilla/websocket | 实时数据推送 |
| 精确计算 | shopspring/decimal | 金融计算 |
| 日志 | uber-go/zap | 结构化日志 |
| 配置 | yaml.v3 | 配置文件解析 |
| 并发 | cmap | 线程安全 Map |

## 开发

```bash
# 安装依赖
go mod tidy

# 运行测试
go test ./...

# 代码格式化
go fmt ./...

# 代码检查
go vet ./...
```

## License

MIT License


akm
